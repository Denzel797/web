{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file://C%3A/Users/Admin/Desktop/sty/diplom3/rideshare-frontend/src/app/chat/%5Bid%5D/page.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect, useRef } from 'react';\r\nimport { use } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { Card, Input, Button, List, Avatar, message, Spin } from 'antd';\r\nimport { SendOutlined, ArrowLeftOutlined } from '@ant-design/icons';\r\n\r\ninterface Message {\r\n  id: number;\r\n  content: string;\r\n  sender: {\r\n    id: number;\r\n    username: string;\r\n    first_name: string;\r\n    last_name: string;\r\n  };\r\n  created_at: string;\r\n  is_read: boolean;\r\n}\r\n\r\ninterface Chat {\r\n  id: number;\r\n  trip: {\r\n    id: number;\r\n    departure_location: string;\r\n    destination_location: string;\r\n  };\r\n  messages: Message[];\r\n  participants: {\r\n    id: number;\r\n    username: string;\r\n    first_name: string;\r\n    last_name: string;\r\n  }[];\r\n}\r\n\r\nexport default function ChatPage({ params }: { params: Promise<{ id: string }> }) {\r\n  const { id } = use(params);\r\n  const router = useRouter();\r\n  const [chat, setChat] = useState<Chat | null>(null);\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [newMessage, setNewMessage] = useState('');\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const [userId, setUserId] = useState<number | null>(null);\r\n\r\n  const scrollToBottom = () => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  };\r\n\r\n  useEffect(() => {\r\n    const user = JSON.parse(localStorage.getItem('user') || '{}');\r\n    setUserId(user.id);\r\n    fetchChat();\r\n    const interval = setInterval(fetchMessages, 5000);\r\n    return () => clearInterval(interval);\r\n  }, [id]);\r\n\r\n  useEffect(() => {\r\n    scrollToBottom();\r\n  }, [messages]);\r\n\r\n  const fetchChat = async () => {\r\n    try {\r\n      const token = localStorage.getItem('access_token');\r\n      if (!token) {\r\n        router.push('/auth/login');\r\n        return;\r\n      }\r\n\r\n      const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/api/chats/${id}/`, {\r\n        headers: {\r\n          'Authorization': `Bearer ${token}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Failed to fetch chat');\r\n      }\r\n\r\n      const data = await response.json();\r\n      setChat(data);\r\n      fetchMessages();\r\n    } catch (error) {\r\n      console.error('Error fetching chat:', error);\r\n      message.error('Не удалось загрузить чат');\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const fetchMessages = async () => {\r\n    try {\r\n      const token = localStorage.getItem('access_token');\r\n      if (!token) {\r\n        router.push('/auth/login');\r\n        return;\r\n      }\r\n\r\n      const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/api/chats/${id}/messages/`, {\r\n        headers: {\r\n          'Authorization': `Bearer ${token}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Failed to fetch messages');\r\n      }\r\n\r\n      const data = await response.json();\r\n      setMessages(data.results || data);\r\n    } catch (error) {\r\n      console.error('Error fetching messages:', error);\r\n    }\r\n  };\r\n\r\n  const handleSendMessage = async () => {\r\n    if (!newMessage.trim()) return;\r\n\r\n    try {\r\n      const token = localStorage.getItem('access_token');\r\n      if (!token) {\r\n        router.push('/auth/login');\r\n        return;\r\n      }\r\n\r\n      const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}/api/chats/${id}/send_message/`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${token}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify({ content: newMessage }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error('Failed to send message');\r\n      }\r\n\r\n      setNewMessage('');\r\n      fetchMessages();\r\n    } catch (error) {\r\n      console.error('Error sending message:', error);\r\n      message.error('Не удалось отправить сообщение');\r\n    }\r\n  };\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"flex justify-center items-center min-h-screen\">\r\n        <Spin size=\"large\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!chat) {\r\n    return (\r\n      <div className=\"flex justify-center items-center min-h-screen\">\r\n        <Card>\r\n          <p>Чат не найден</p>\r\n          <Button onClick={() => router.back()}>Назад</Button>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50 py-8 px-4\">\r\n      <div className=\"max-w-3xl mx-auto\">\r\n        <Card\r\n          title={\r\n            <div className=\"flex items-center gap-4\">\r\n              <Button\r\n                icon={<ArrowLeftOutlined />}\r\n                onClick={() => router.back()}\r\n              />\r\n              <span>\r\n                Чат поездки: {chat.trip.departure_location} → {chat.trip.destination_location}\r\n              </span>\r\n            </div>\r\n          }\r\n          className=\"shadow-lg\"\r\n        >\r\n          <div className=\"h-[60vh] flex flex-col\">\r\n            <div className=\"flex-1 overflow-y-auto mb-4 p-4 space-y-4\">\r\n              {messages.map((msg) => (\r\n                <div\r\n                  key={msg.id}\r\n                  className={`flex items-start gap-2 ${\r\n                    msg.sender.id === userId ? 'flex-row-reverse' : 'flex-row'\r\n                  }`}\r\n                >\r\n                  <Avatar\r\n                    style={{\r\n                      backgroundColor: msg.sender.id === userId ? '#52c41a' : '#1890ff',\r\n                      flexShrink: 0\r\n                    }}\r\n                  >\r\n                    {msg.sender.first_name?.[0] || msg.sender.username[0]}\r\n                  </Avatar>\r\n                  <div\r\n                    className={`\r\n                      flex flex-col\r\n                      ${msg.sender.id === userId ? 'items-end' : 'items-start'}\r\n                      max-w-[60%]\r\n                    `}\r\n                  >\r\n                    {msg.sender.id !== userId && (\r\n                      <span className=\"text-xs text-gray-500 mb-1 px-2\">\r\n                        {msg.sender.first_name || msg.sender.username}\r\n                      </span>\r\n                    )}\r\n                    <div\r\n                      className={`\r\n                        rounded-2xl px-4 py-2\r\n                        ${msg.sender.id === userId\r\n                          ? 'bg-blue-500 text-white rounded-tr-none'\r\n                          : 'bg-gray-100 text-gray-800 rounded-tl-none'\r\n                        }\r\n                      `}\r\n                    >\r\n                      <div className=\"break-words whitespace-pre-wrap\">\r\n                        {msg.content}\r\n                      </div>\r\n                    </div>\r\n                    <div\r\n                      className={`\r\n                        text-xs mt-1 px-2\r\n                        ${msg.sender.id === userId ? 'text-gray-500' : 'text-gray-400'}\r\n                      `}\r\n                    >\r\n                      {new Date(msg.created_at).toLocaleTimeString([], {\r\n                        hour: '2-digit',\r\n                        minute: '2-digit'\r\n                      })}\r\n                      {msg.sender.id === userId && (\r\n                        <span className=\"ml-2 text-gray-400\">\r\n                          {msg.is_read ? '✓✓' : '✓'}\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n              <div ref={messagesEndRef} />\r\n            </div>\r\n            <div className=\"flex gap-2 mt-4 border-t pt-4 px-4\">\r\n              <Input\r\n                value={newMessage}\r\n                onChange={(e) => setNewMessage(e.target.value)}\r\n                onPressEnter={handleSendMessage}\r\n                placeholder=\"Введите сообщение...\"\r\n                className=\"flex-1\"\r\n                size=\"large\"\r\n              />\r\n              <Button\r\n                type=\"primary\"\r\n                icon={<SendOutlined />}\r\n                onClick={handleSendMessage}\r\n                size=\"large\"\r\n              >\r\n                Отправить\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  );\r\n} "],"names":[],"mappings":"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","debugId":null}}]
}